<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mietstationen verwalten</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('background.png') center/cover no-repeat;
      color: #f5f5f5;
      min-height: 100vh;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      padding: 2rem 3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo img {
      height: 50px;
    }

    .logo span {
      font-size: 1.8rem;
      font-weight: 700;
      color: #facc15;
    }

    nav {
      display: flex;
      gap: 2rem;
    }

    nav a {
      color: #f5f5f5;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s, transform 0.3s;
    }

    nav a:hover {
      color: #facc15;
      transform: scale(1.05);
    }

    main {
      display: flex;
      gap: 2rem;
      padding: 9rem 2rem 3rem;
      max-width: 1200px;
      margin: auto;
    }

    .stationen-section, .form-section {
      flex: 1;
      background: rgba(17, 17, 17, 0.6);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      max-height: 80vh;
    }

    .station-card {
      border: 1px solid #444;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      background-color: #2a2a2a;
    }

    label {
      display: block;
      margin-top: 1rem;
    }

    input, select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: none;
      background: #2a2a2a;
      color: #f5f5f5;
      margin-top: 0.5rem;
    }

    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: #facc15;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #eab308;
    }

     #fahrzeugModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
</style>
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="logo.png" alt="Logo" />
      <span>Autovermietung</span>
    </div>
    <nav>
      <a href="main.html">Home</a>
      <a href="mietstationen.html">Mietstationen</a>
      <a href="performance.html">Performance</a>
      <a href="personal.html">Personaleinsatz</a>
    </nav>
  </header>

  <main>
    <section class="stationen-section fadeIn">
      <h2>Bestehende Mietstationen</h2>
      <div id="stationList"></div>
    </section>

    <section class="form-section fadeIn">
      <h2>Neue Mietstation anlegen</h2>
      <form id="mietstationForm">
        <label for="name">Name</label>
        <input type="text" id="name" required />
        <label for="address">Adresse</label>
        <input type="text" id="address" required />
        <label for="phone">Telefon</label>
        <input type="tel" id="phone" required />
        <label for="email">E-Mail</label>
        <input type="email" id="email" required />
        <label for="capacity">Kapazit√§t</label>
        <input type="number" id="capacity" required />
        <label for="aufbereitung">Fahrzeugaufbereitung</label>
        <select id="aufbereitung">
          <option>Nein</option>
          <option>Ja - intern</option>
          <option>Ja - extern</option>
        </select>
        <label for="schadensregulierung">Schadensregulierung</label>
        <select id="schadensregulierung">
          <option>Nein</option>
          <option>Ja</option>
        </select>
        <label for="lage">Lage</label>
        <select id="lage">
          <option>Innenstadt</option>
          <option>Flughafen</option>
          <option>Tourismuszentrum</option>
          <option>Bahnhof</option>
        </select>
        <button type="submit">Speichern</button>
        <button type="button" id="cancelEdit" style="margin-left: 1rem; background: #dc2626; color: white; display: none;">‚ùå Bearbeiten abbrechen</button>
      </form>
    </section>
  </main>

 <!-- Fahrzeug-Modal -->
<div id="fahrzeugModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#1e1e1e; padding:2rem; border-radius:1rem; max-width:500px; width:90%; color:#fff; position:relative;">
    <button onclick="closeVehicleModal()" style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; color:#fff; cursor:pointer;">√ó</button>
    <div id="modalContent"></div>
  </div>
</div>

  <script>
  let editingId = null;
  const form = document.getElementById('mietstationForm');
  const stationList = document.getElementById('stationList');
  const cancelButton = document.getElementById('cancelEdit');

  cancelButton.onclick = () => {
    editingId = null;
    form.reset();
    cancelButton.style.display = 'none';
  };

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const newStation = {
      name: document.getElementById('name').value,
      adresse: document.getElementById('address').value,
      telefon: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      kapazitaet: parseInt(document.getElementById('capacity').value),
      aufbereitung: document.getElementById('aufbereitung').value,
      schadensregulierung: document.getElementById('schadensregulierung').value === 'Ja',
      lage: document.getElementById('lage').value
    };

    const url = editingId
      ? `http://localhost:3000/api/mietstationen/${editingId}`
      : 'http://localhost:3000/api/mietstationen';
    const method = editingId ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newStation)
      });

      if (!res.ok) throw new Error(editingId ? 'Fehler beim Bearbeiten' : 'Fehler beim Speichern');
      alert(`‚úÖ Mietstation ${editingId ? 'bearbeitet' : 'gespeichert'}!`);
      editingId = null;
      cancelButton.style.display = 'none';
      form.reset();
      loadStations();
    } catch (err) {
      alert('‚ùå ' + err.message);
    }
  });

  function editStation(id) {
    fetch('http://localhost:3000/api/mietstationen')
      .then(res => res.json())
      .then(stationen => {
        const station = stationen.find(s => s.id === parseInt(id));
        if (!station) return alert('‚ùå Station nicht gefunden');

        document.getElementById('name').value = station.name;
        document.getElementById('address').value = station.adresse;
        document.getElementById('phone').value = station.telefon;
        document.getElementById('email').value = station.email;
        document.getElementById('capacity').value = station.kapazitaet;
        document.getElementById('aufbereitung').value = station.aufbereitung;
        document.getElementById('schadensregulierung').value = station.schadensregulierung ? 'Ja' : 'Nein';
        document.getElementById('lage').value = station.lage;

        editingId = station.id;
        cancelButton.style.display = 'inline-block';
      });
  }

  function deleteStation(id) {
    fetch(`http://localhost:3000/api/mietstationen/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Fehler beim L√∂schen');
        loadStations();
      })
      .catch(err => alert('‚ùå ' + err.message));
  }

  function showVehicleDetails(f) {
    const modal = document.getElementById("fahrzeugModal");
    const content = document.getElementById("modalContent");

    content.innerHTML = `
      <img src="/autos/${f.bild}" alt="${f.marke}" style="width:100%; border-radius:0.5rem; margin-bottom:1rem;" />
      <h3>${f.marke}</h3>
      <p><strong>Typ:</strong> ${f.typ}</p>
      <p><strong>Kraftstoff:</strong> ${f.kraftstoff}</p>
      <p><strong>Kilometerstand:</strong> ${f.kilometer.toLocaleString()} km</p>
      <p><strong>Preis pro Tag:</strong> ${f.preisProTag} ‚Ç¨</p>
      <p><strong>Verf√ºgbar:</strong> ${f.verfuegbar ? '‚úÖ Ja' : '‚ùå Nein'}</p>
    `;
    modal.style.display = 'flex';
  }

  function closeVehicleModal() {
    document.getElementById("fahrzeugModal").style.display = 'none';
  }

  function loadStations() {
    fetch('http://localhost:3000/api/mietstationen')
      .then(res => res.json())
      .then(stationen => {
        stationList.innerHTML = '';
        stationen.forEach(station => {
          const div = document.createElement('div');
          div.className = 'station-card';

          div.innerHTML = `
            <strong>${station.name}</strong><br/>
            ${station.adresse}<br/>
            Tel: ${station.telefon}<br/>
            E-Mail: ${station.email}<br/>
            Kapazit√§t: ${station.kapazitaet}<br/>
            Aufbereitung: ${station.aufbereitung}<br/>
            Schadensregulierung: ${station.schadensregulierung ? 'Ja' : 'Nein'}<br/>
            Lage: ${station.lage}<br/>
            <button onclick="editStation(${station.id})">‚úèÔ∏è Bearbeiten</button>
            <button onclick="deleteStation(${station.id})">üóëÔ∏è L√∂schen</button>
            <button onclick="toggleVehicleForm(${station.id})">‚ûï Fahrzeug hinzuf√ºgen</button>
            <div id="fahrzeuge-${station.id}" style="margin-top: 1rem;"></div>
            <div id="vehicle-form-${station.id}" style="margin-top:1rem;"></div>
          `;
          stationList.appendChild(div);

          fetch(`http://localhost:3000/api/stationen/${station.id}/fahrzeuge`)
            .then(res => res.json())
            .then(fahrzeuge => {
              const fahrzeugDiv = document.getElementById(`fahrzeuge-${station.id}`);
              if (!fahrzeuge.length) {
                fahrzeugDiv.innerHTML = '<p style="color:#999;">Keine Fahrzeuge vorhanden.</p>';
                return;
              }

              const html = fahrzeuge.map(f => `
                <div onclick='showVehicleDetails(${JSON.stringify(f)})' style="cursor:pointer; margin-top:1rem;">
                  <img src="/autos/${f.bild}" alt="${f.marke}" style="width: 150px; border-radius: 0.5rem;" />
                </div>
              `).join('');

              fahrzeugDiv.innerHTML = `<h4>Fahrzeuge:</h4>${html}`;
            });
        });
      });
  }

  async function toggleVehicleForm(stationId) {
    const container = document.getElementById(`vehicle-form-${stationId}`);
    container.innerHTML = '';
    container.style.display = 'block';

    const res = await fetch('http://localhost:3000/api/fahrzeugtypen');
    const typen = await res.json();

    const grid = document.createElement('div');
    grid.style.display = 'flex';
    grid.style.flexWrap = 'wrap';
    grid.style.gap = '1rem';

    let selectedTyp = null;

    typen.forEach(t => {
      const img = document.createElement('img');
      img.src = `/autos/${t.bild}`;
      img.alt = t.bezeichnung;
      img.title = `${t.marke} (${t.typ}) ‚Äì ${t.kraftstoff}`;
      img.style.width = '100px';
      img.style.borderRadius = '0.5rem';
      img.style.cursor = 'pointer';
      img.onclick = () => {
        selectedTyp = t;
        document.getElementById(`km-${stationId}`).style.display = 'block';
        document.getElementById(`verfuegbar-wrap-${stationId}`).style.display = 'block';
        document.getElementById(`save-${stationId}`).style.display = 'inline-block';
        [...grid.children].forEach(i => i.style.border = 'none');
        img.style.border = '3px solid #facc15';
      };
      grid.appendChild(img);
    });

    const kmField = `<input type="number" id="km-${stationId}" placeholder="Kilometerstand z.B. 42000" style="display:none; width:100%; margin-top:1rem;" />`;
    const checkbox = `<div id="verfuegbar-wrap-${stationId}" style="display:none; margin-top:1rem;"><label><input type="checkbox" id="verfuegbar-${stationId}" checked /> Verf√ºgbar</label></div>`;
    const saveBtn = `<button id="save-${stationId}" onclick="submitVehicleForm(${stationId})" style="display:none; margin-top:1rem;">üöó Speichern</button>`;

    container.appendChild(grid);
    container.insertAdjacentHTML('beforeend', kmField + checkbox + saveBtn);
  }

  async function submitVehicleForm(stationId) {
    const km = parseInt(document.getElementById(`km-${stationId}`).value);
    const verfuegbar = document.getElementById(`verfuegbar-${stationId}`).checked;
    const img = document.querySelector(`#vehicle-form-${stationId} img[style*="3px solid"]`);
    if (!img) return alert('‚ùó Bitte ein Fahrzeug w√§hlen');

    const alt = img.getAttribute('alt');
    const res = await fetch('http://localhost:3000/api/fahrzeugtypen');
    const typen = await res.json();
    const typ = typen.find(t => t.bezeichnung === alt);

    if (!typ || isNaN(km)) {
      return alert('‚ùó Bitte g√ºltigen Kilometerstand angeben.');
    }

    const newVehicle = {
      stationId,
      marke: typ.marke,
      typ: typ.typ,
      kraftstoff: typ.kraftstoff,
      kilometer: km,
      preisProTag: typ.preisProTag,
      bild: typ.bild,
      verfuegbar
    };

    const save = await fetch('http://localhost:3000/api/fahrzeuge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newVehicle)
    });

    if (!save.ok) return alert('‚ùå Fahrzeug konnte nicht gespeichert werden.');
    alert('‚úÖ Fahrzeug gespeichert!');
    loadStations();
  }

  loadStations();
</script>




</body>
</html>
